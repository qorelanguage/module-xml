#!/usr/bin/env qore

%new-style
%enable-all-warnings

%requires HttpServer
%requires ../qlib/WebDavHandler
%requires QUnit
%requires FsUtil

%exec-class Main

# logger for http server
sub http_log(string str) {
#    printf("%N: %s\n", now_us(), vsprintf(str, argv));
}

# minimal HTTP server for this test suite
class Server inherits HttpServer {
    private {
        WebDavHandler::WebDavHandlerHandler handler;
        int port;
    }

    constructor(WebDavHandler::AbstractWebDavHandlerInterface iface) : HttpServer(\http_log(), \http_log()) {
        handler = new WebDavHandler::WebDavHandlerHandler(iface);
        setHandler("webdavhandler", "/", NOTHING, handler);
        setDefaultHandler("webdavhandler", handler);

        map addHttpMethod($1), handler.getHttpMethods();

        port = addListener(<HttpListenerOptionInfo>{"service": 0}).port;
    }

    int getPort() {
        return port;
    }

} # class Server

class Client inherits HTTPClient {
    constructor(string url) : HTTPClient({
        "url": url,
        "additional_methods": WebDavHandler::AbstractWebDavHandlerInterface::RequestMethods,
    }) {
    }
}


class Main inherits QUnit::Test {
    constructor() : QUnit::Test("webdavhandler", "1.0") {
        addTestCase("FS webdavhandler test", \test());

        set_return_value(main());
    }

    # test presence of extended HTTP methods in the server
    private test() {
        TmpDir tmp();
        WebDavHandler::InMemoryWebDavPropertyHandler props();
        WebDavHandler::FsWebDavHandlerInterface iface(props, tmp.path);
        Server srv(iface);
        on_exit {
            srv.stop();
        }
    }
} # class Main

