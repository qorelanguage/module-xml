#!/usr/bin/env qore

%new-style
%enable-all-warnings

%requires HttpServer
%requires ../qlib/WebDavHandler
%requires QUnit
%requires FsUtil

%exec-class Main

# minimal HTTP server for this test suite
class Server inherits HttpServer {
    private {
        int port;
    }

    constructor(WebDavHandler::AbstractWebDavHandler handler) : HttpServer() {
        setHandler("webdavhandler", "/", NOTHING, handler);
        setDefaultHandler("webdavhandler", handler);

        map addHttpMethod($1), handler.getHttpMethods();

        port = addListener(<HttpListenerOptionInfo>{"service": 0}).port;
    }

    int getPort() {
        return port;
    }

} # class Server

class Client inherits HTTPClient {
    constructor(string url) : HTTPClient({
        "url": url,
        "additional_methods": WebDavHandler::AbstractWebDavHandler::RequestMethods,
    }) {
    }
}


class Main inherits QUnit::Test {
    constructor() : QUnit::Test("webdavhandler", "1.0") {
        addTestCase("FS webdavhandler test", \test());

        set_return_value(main());
    }

    # test presence of extended HTTP methods in the server
    private test() {
        TmpDir tmp();
        WebDavHandler::FsWebDavHandler handler(tmp.path);
        Server srv(handler);
        on_exit {
            srv.stop();
        }
    }
} # class Main

